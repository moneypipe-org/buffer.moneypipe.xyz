<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="moneypipe buffer" />
<meta name="twitter:description" content="create a group to collect money and let members withdraw their share" />
<meta name="twitter:image" content="https://buffer.moneypipe.xyz/mp.png" />
<meta property="og:url" content="https://buffer.moneypipe.xyz" />
<meta property="og:type" content="website" />
<meta property="og:title" content="moneypipe buffer" />
<meta property="og:description" content="create a group to collect money and let members withdraw their share" />
<meta property="og:image" content="https://buffer.moneypipe.xyz/mp.png" />
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://unpkg.com/ipfsh@0.0.3/dist/ipfsh.min.js"></script>
<script src="https://unpkg.com/merklescript@0.0.2/dist/merklescript.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@3.0.0/dist/web3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/randomcolor/0.6.1/randomColor.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.7.7/handlebars.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta2/css/all.min.css" rel="stylesheet">
<link href="/style.css" rel="stylesheet">
<script src="factory_abi.js"></script>
<script src="group_abi.js"></script>
<script src="config.js"></script>
<script id="template" type="text/x-handlebars-template">
{{#each accounts}}
  <tr class='field'>
    <td class='account'>{{account}}</td>
    <td><input value={{val}} class='value' type='number' placeholder='split portion (1, 10, 100, ...)'></td>
  </tr>
{{/each}}
</script>
<script>
var CONTRACT_ADDRESS = location.hash.slice(1).split("=")[1]
var web3 = new Web3(window.ethereum);
var factory = new web3.eth.Contract(factory_abi, Config.address);
var template = Handlebars.compile(document.querySelector("#template").innerHTML)
var account
var chart;
google.charts.load('current', {'packages':['sankey']});
const update = () => {
  let total = 0
  parts = []
  document.querySelectorAll(".field").forEach((el) => {
    let account = el.querySelector(".account").textContent
    let value = parseInt(el.querySelector(".value").value)
    if (!value || isNaN(value)) value = 1;
    total += value
    parts.push({
      account, value
    })
  })
  parts.forEach((part) => {
    console.log("part", part)
    part.total = total
//    part.value = Math.floor((part.value / total) * total)
  })
}
const draw = () => {
  let data = new google.visualization.DataTable();
  data.addColumn('string', 'From');
  data.addColumn('string', 'To');
  data.addColumn('number', 'Weight');
  let total = 0;
  parts.forEach((part) => {
    total += part.value
  })
  let rows = parts.map((part) => {
    return [
      "Input",
      `${part.account} (${Math.floor(part.value/total*10000)/100}%)`,
      part.value
    ]
  })
  console.log("rows", rows)
  data.addRows(rows)

  let chart = new google.visualization.Sankey(document.getElementById('chart'))
  chart.draw(data, {
    width: "100%",
    height: 20 * rows.length,
    sankey: {
      node: {
        label: {
          color: "#ffffff",
          fontSize: 12
        }
      },
      link: {
        colorMode: 'gradient',
        color: { fill: '#ffffff' },
      }
    }
  })
}
var parts = []
document.addEventListener("DOMContentLoaded", async () => {
  await ethereum.request({ method: 'eth_requestAccounts' })
  let _res = await web3.eth.getAccounts()
  account = _res[0];
  document.querySelector(".ratio-form").addEventListener("submit", async (e) => {
    e.preventDefault()
    e.stopPropagation()
    debugger;
    update()
    // convert to 1000,0000
    console.log("parts", parts)
    let name = document.querySelector(".name").value
    if (!name || name.length === 0) {
      alert("Please enter the pipe name")
      return;
    }
    e.target.querySelector("input[type=submit]").classList.add("hidden")
    document.querySelector(".loading").classList.remove("hidden")


    let values = parts.map((part) => {
      return [
        part.account,
        Math.floor((part.value / part.total) * Math.pow(10, 12))
      ]
    })
    console.log("values = ", values)

    // convert to merkle tree
    const s = {
      types: ["address", "uint256"],
      values: values
    }
    const script = new Merklescript(s)
    const root = script.root()

    // store merkle tree on IPFS
    let cid = await fetch("https://microipfs.com/add", {
      method: "post",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        object: {
          merklescript: s
        }
      })
    }).then((r) => {
      return r.json()
    }).then((r) => {
      return r.success
    })
    console.log("cid", cid)

    let cidDigest = ipfsh.ctod(cid)
    console.log("cidDigest = ", cidDigest)
    let tx = await factory.methods.genesis(name, root, cidDigest).send({
      from: account 
    })
    console.log("tx", tx)
    let address = tx.events.ContractDeployed.returnValues.group
    location.href = "group#address=" + address
  })
  document.querySelector(".form").addEventListener("input", () => {
    update()
    draw()
  })
  document.querySelector(".address-form").addEventListener("submit", async (e) => {
    e.target.classList.add("hidden")
    document.querySelector(".ratio-form").classList.remove("hidden")
    document.querySelector("header").classList.remove("hidden")
    e.preventDefault()
    e.stopPropagation()
    let addresses = e.target.querySelector(".addresses").value.split("\n").filter((x) => {
      return x && x.length > 0
    })
    let items = addresses.map((x) => {
      return {
        account: x.trim(),
        val: 1
      }
    })
    document.querySelector(".form").innerHTML = template({ accounts: items })
    update()
    draw()
  })

})
</script>
</head>
<body>
<nav>
  <div class='brand'>
    <a href="https://moneypipe.xyz">moneypipe</a><span class='separator'>.</span><a href="/">buffer</a><span class='separator'>.</span><a href=".">rinkeby</a>
  </div>
  <div class='subtitle'>create a group to collect money and let members withdraw their share</div>
  <div>
    <a class='btn' href="../../about">How does it work?</a>
    <a class='btn' href="https://discord.gg/BZtp5F6QQM"><i class="fa-brands fa-discord"></i> Discord</a>
    <a class='btn' href="https://twitter.com/skogard"><i class="fa-brands fa-twitter"></i> Twitter</a>
    <a class='btn' href='https://github.com/moneypipe-org'><i class="fa-brands fa-github"></i> GitHub</a>
  </div>
</nav>
<header class='hidden'>
  <div id='chart'></div>
</header>
<div class='container'>
<form class='address-form'>
  <textarea class='addresses' placeholder="enter line separated addresses"></textarea>
  <input type='submit' class='btn' value='next'>
</form>
<form class='ratio-form hidden'>
  <div class='name-form'>
    <input type='text' placeholder="pipe name" class='name'>
  </div>
  <table class='form'></table>
  <input type='submit' class='btn thick' value='OK'>
  <div class='loading hidden'>
    <i class="fa-solid fa-angle-up fa-flip"></i> creating a pipe...
  </div>
</form>
</div>
</body>
</html>
